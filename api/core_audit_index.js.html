<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>core/audit/index.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AIServiceManager.html">AIServiceManager</a><ul class='methods'><li data-type='method'><a href="AIServiceManager.html#classifyText">classifyText</a></li><li data-type='method'><a href="AIServiceManager.html#generateEmbeddings">generateEmbeddings</a></li><li data-type='method'><a href="AIServiceManager.html#generateText">generateText</a></li><li data-type='method'><a href="AIServiceManager.html#getService">getService</a></li><li data-type='method'><a href="AIServiceManager.html#initialize">initialize</a></li><li data-type='method'><a href="AIServiceManager.html#initializeService">initializeService</a></li><li data-type='method'><a href="AIServiceManager.html#processImage">processImage</a></li></ul></li><li><a href="AdminInterfaceGenerator.html">AdminInterfaceGenerator</a><ul class='methods'><li data-type='method'><a href="AdminInterfaceGenerator.html#generateRoutes">generateRoutes</a></li><li data-type='method'><a href="AdminInterfaceGenerator.html#initialize">initialize</a></li><li data-type='method'><a href="AdminInterfaceGenerator.html#loadModels">loadModels</a></li><li data-type='method'><a href="AdminInterfaceGenerator.html#serveAdminUI">serveAdminUI</a></li><li data-type='method'><a href="AdminInterfaceGenerator.html#setupAuthentication">setupAuthentication</a></li></ul></li><li><a href="AuditManager.html">AuditManager</a><ul class='methods'><li data-type='method'><a href="AuditManager.html#createAuditContext">createAuditContext</a></li><li data-type='method'><a href="AuditManager.html#createAuditMiddleware">createAuditMiddleware</a></li><li data-type='method'><a href="AuditManager.html#createAuditTables">createAuditTables</a></li><li data-type='method'><a href="AuditManager.html#executeRightToBeForgotten">executeRightToBeForgotten</a></li><li data-type='method'><a href="AuditManager.html#generateGDPRExport">generateGDPRExport</a></li><li data-type='method'><a href="AuditManager.html#getAccessLogsForEntity">getAccessLogsForEntity</a></li><li data-type='method'><a href="AuditManager.html#getAuditLogsForEntity">getAuditLogsForEntity</a></li><li data-type='method'><a href="AuditManager.html#initialize">initialize</a></li><li data-type='method'><a href="AuditManager.html#logAccess">logAccess</a></li><li data-type='method'><a href="AuditManager.html#logChanges">logChanges</a></li><li data-type='method'><a href="AuditManager.html#sanitizeRequestBody">sanitizeRequestBody</a></li><li data-type='method'><a href="AuditManager.html#shouldAuditRequest">shouldAuditRequest</a></li></ul></li><li><a href="CacheManager.html">CacheManager</a><ul class='methods'><li data-type='method'><a href="CacheManager.html#clearNamespace">clearNamespace</a></li><li data-type='method'><a href="CacheManager.html#createMiddleware">createMiddleware</a></li><li data-type='method'><a href="CacheManager.html#delete">delete</a></li><li data-type='method'><a href="CacheManager.html#generateKey">generateKey</a></li><li data-type='method'><a href="CacheManager.html#get">get</a></li><li data-type='method'><a href="CacheManager.html#getOrSet">getOrSet</a></li><li data-type='method'><a href="CacheManager.html#set">set</a></li></ul></li><li><a href="EdgeComputingManager.html">EdgeComputingManager</a><ul class='methods'><li data-type='method'><a href="EdgeComputingManager.html#applyChangesFromEdge">applyChangesFromEdge</a></li><li data-type='method'><a href="EdgeComputingManager.html#applyCreateChange">applyCreateChange</a></li><li data-type='method'><a href="EdgeComputingManager.html#applyDeleteChange">applyDeleteChange</a></li><li data-type='method'><a href="EdgeComputingManager.html#applyUpdateChange">applyUpdateChange</a></li><li data-type='method'><a href="EdgeComputingManager.html#deployFunctionToEdge">deployFunctionToEdge</a></li><li data-type='method'><a href="EdgeComputingManager.html#executeFunctionOnEdge">executeFunctionOnEdge</a></li><li data-type='method'><a href="EdgeComputingManager.html#fetchPendingChanges">fetchPendingChanges</a></li><li data-type='method'><a href="EdgeComputingManager.html#getAllEdgeNodesStatus">getAllEdgeNodesStatus</a></li><li data-type='method'><a href="EdgeComputingManager.html#getEdgeNodeStatus">getEdgeNodeStatus</a></li><li data-type='method'><a href="EdgeComputingManager.html#getPendingChangesForNode">getPendingChangesForNode</a></li><li data-type='method'><a href="EdgeComputingManager.html#initialize">initialize</a></li><li data-type='method'><a href="EdgeComputingManager.html#loadEdgeNodes">loadEdgeNodes</a></li><li data-type='method'><a href="EdgeComputingManager.html#markChangeAsProcessed">markChangeAsProcessed</a></li><li data-type='method'><a href="EdgeComputingManager.html#pushChangesToEdge">pushChangesToEdge</a></li><li data-type='method'><a href="EdgeComputingManager.html#registerEdgeNode">registerEdgeNode</a></li><li data-type='method'><a href="EdgeComputingManager.html#signChange">signChange</a></li><li data-type='method'><a href="EdgeComputingManager.html#synchronizeAll">synchronizeAll</a></li><li data-type='method'><a href="EdgeComputingManager.html#synchronizeNode">synchronizeNode</a></li><li data-type='method'><a href="EdgeComputingManager.html#unregisterEdgeNode">unregisterEdgeNode</a></li><li data-type='method'><a href="EdgeComputingManager.html#validateChangeSignature">validateChangeSignature</a></li></ul></li><li><a href="EventManager.html">EventManager</a><ul class='methods'><li data-type='method'><a href="EventManager.html#getEvents">getEvents</a></li><li data-type='method'><a href="EventManager.html#initialize">initialize</a></li><li data-type='method'><a href="EventManager.html#initializeEventStore">initializeEventStore</a></li><li data-type='method'><a href="EventManager.html#initializeMessageQueue">initializeMessageQueue</a></li><li data-type='method'><a href="EventManager.html#publishEvent">publishEvent</a></li><li data-type='method'><a href="EventManager.html#replayEvents">replayEvents</a></li><li data-type='method'><a href="EventManager.html#setupMessageHandlers">setupMessageHandlers</a></li><li data-type='method'><a href="EventManager.html#subscribeToEvent">subscribeToEvent</a></li><li data-type='method'><a href="EventManager.html#unsubscribeFromEvent">unsubscribeFromEvent</a></li></ul></li><li><a href="I18nManager.html">I18nManager</a><ul class='methods'><li data-type='method'><a href="I18nManager.html#changeLanguage">changeLanguage</a></li><li data-type='method'><a href="I18nManager.html#createSampleLocales">createSampleLocales</a></li><li data-type='method'><a href="I18nManager.html#formatCurrency">formatCurrency</a></li><li data-type='method'><a href="I18nManager.html#formatDate">formatDate</a></li><li data-type='method'><a href="I18nManager.html#formatNumber">formatNumber</a></li><li data-type='method'><a href="I18nManager.html#getCurrentLanguage">getCurrentLanguage</a></li><li data-type='method'><a href="I18nManager.html#getMiddleware">getMiddleware</a></li><li data-type='method'><a href="I18nManager.html#getSupportedLanguages">getSupportedLanguages</a></li><li data-type='method'><a href="I18nManager.html#initialize">initialize</a></li><li data-type='method'><a href="I18nManager.html#translate">translate</a></li></ul></li><li><a href="MockDatabase.html">MockDatabase</a></li><li><a href="MockDatabaseClient.html">MockDatabaseClient</a></li><li><a href="MonitoringManager.html">MonitoringManager</a><ul class='methods'><li data-type='method'><a href="MonitoringManager.html#createMiddleware">createMiddleware</a></li><li data-type='method'><a href="MonitoringManager.html#getMetricsHandler">getMetricsHandler</a></li><li data-type='method'><a href="MonitoringManager.html#incrementCounter">incrementCounter</a></li><li data-type='method'><a href="MonitoringManager.html#initialize">initialize</a></li><li data-type='method'><a href="MonitoringManager.html#initializeDatadog">initializeDatadog</a></li><li data-type='method'><a href="MonitoringManager.html#initializeNewRelic">initializeNewRelic</a></li><li data-type='method'><a href="MonitoringManager.html#initializePrometheus">initializePrometheus</a></li><li data-type='method'><a href="MonitoringManager.html#initializeProvider">initializeProvider</a></li><li data-type='method'><a href="MonitoringManager.html#recordHistogram">recordHistogram</a></li><li data-type='method'><a href="MonitoringManager.html#recordMetric">recordMetric</a></li><li data-type='method'><a href="MonitoringManager.html#shutdown">shutdown</a></li><li data-type='method'><a href="MonitoringManager.html#startSystemMetricsCollection">startSystemMetricsCollection</a></li><li data-type='method'><a href="MonitoringManager.html#startTimer">startTimer</a></li></ul></li><li><a href="OpenAIService.html">OpenAIService</a><ul class='methods'><li data-type='method'><a href="OpenAIService.html#classifyText">classifyText</a></li><li data-type='method'><a href="OpenAIService.html#generateEmbeddings">generateEmbeddings</a></li><li data-type='method'><a href="OpenAIService.html#generateText">generateText</a></li><li data-type='method'><a href="OpenAIService.html#initialize">initialize</a></li><li data-type='method'><a href="OpenAIService.html#processImage">processImage</a></li></ul></li><li><a href="PluginManager.html">PluginManager</a><ul class='methods'><li data-type='method'><a href="PluginManager.html#createMiddleware">createMiddleware</a></li><li data-type='method'><a href="PluginManager.html#executeHooks">executeHooks</a></li><li data-type='method'><a href="PluginManager.html#loadPlugins">loadPlugins</a></li><li data-type='method'><a href="PluginManager.html#register">register</a></li></ul></li><li><a href="PostgresEventStore.html">PostgresEventStore</a><ul class='methods'><li data-type='method'><a href="PostgresEventStore.html#getEvents">getEvents</a></li><li data-type='method'><a href="PostgresEventStore.html#initialize">initialize</a></li><li data-type='method'><a href="PostgresEventStore.html#storeEvent">storeEvent</a></li></ul></li><li><a href="RedisQueue.html">RedisQueue</a><ul class='methods'><li data-type='method'><a href="RedisQueue.html#initialize">initialize</a></li><li data-type='method'><a href="RedisQueue.html#publish">publish</a></li><li data-type='method'><a href="RedisQueue.html#subscribe">subscribe</a></li><li data-type='method'><a href="RedisQueue.html#unsubscribe">unsubscribe</a></li></ul></li><li><a href="SecurityAuditManager.html">SecurityAuditManager</a><ul class='methods'><li data-type='method'><a href="SecurityAuditManager.html#createAuditTables">createAuditTables</a></li><li data-type='method'><a href="SecurityAuditManager.html#createMiddleware">createMiddleware</a></li><li data-type='method'><a href="SecurityAuditManager.html#getSecurityAuditLogs">getSecurityAuditLogs</a></li><li data-type='method'><a href="SecurityAuditManager.html#initialize">initialize</a></li><li data-type='method'><a href="SecurityAuditManager.html#logSecurityEvent">logSecurityEvent</a></li><li data-type='method'><a href="SecurityAuditManager.html#shutdown">shutdown</a></li></ul></li><li><a href="SecurityScanner.html">SecurityScanner</a><ul class='methods'><li data-type='method'><a href="SecurityScanner.html#countIssues">countIssues</a></li><li data-type='method'><a href="SecurityScanner.html#findSourceFiles">findSourceFiles</a></li><li data-type='method'><a href="SecurityScanner.html#generateRecommendations">generateRecommendations</a></li><li data-type='method'><a href="SecurityScanner.html#generateReport">generateReport</a></li><li data-type='method'><a href="SecurityScanner.html#getConfigFiles">getConfigFiles</a></li><li data-type='method'><a href="SecurityScanner.html#getJsFiles">getJsFiles</a></li><li data-type='method'><a href="SecurityScanner.html#getLineNumber">getLineNumber</a></li><li data-type='method'><a href="SecurityScanner.html#initialize">initialize</a></li><li data-type='method'><a href="SecurityScanner.html#runAllScans">runAllScans</a></li><li data-type='method'><a href="SecurityScanner.html#runScan">runScan</a></li><li data-type='method'><a href="SecurityScanner.html#saveReport">saveReport</a></li><li data-type='method'><a href="SecurityScanner.html#scanCode">scanCode</a></li><li data-type='method'><a href="SecurityScanner.html#scanCode">scanCode</a></li><li data-type='method'><a href="SecurityScanner.html#scanConfigurations">scanConfigurations</a></li><li data-type='method'><a href="SecurityScanner.html#scanDependencies">scanDependencies</a></li><li data-type='method'><a href="SecurityScanner.html#scanDependencies">scanDependencies</a></li><li data-type='method'><a href="SecurityScanner.html#scanEndpoints">scanEndpoints</a></li><li data-type='method'><a href="SecurityScanner.html#sendEmailNotification">sendEmailNotification</a></li><li data-type='method'><a href="SecurityScanner.html#sendNotifications">sendNotifications</a></li><li data-type='method'><a href="SecurityScanner.html#sendSlackNotification">sendSlackNotification</a></li><li data-type='method'><a href="SecurityScanner.html#shutdown">shutdown</a></li></ul></li><li></li><li><a href="ServerlessAdapter.html">ServerlessAdapter</a><ul class='methods'><li data-type='method'><a href="ServerlessAdapter.html#createAWSHandler">createAWSHandler</a></li><li data-type='method'><a href="ServerlessAdapter.html#createAzureHandler">createAzureHandler</a></li><li data-type='method'><a href="ServerlessAdapter.html#createGCPHandler">createGCPHandler</a></li><li data-type='method'><a href="ServerlessAdapter.html#initialize">initialize</a></li></ul></li><li><a href="TenantManager.html">TenantManager</a><ul class='methods'><li data-type='method'><a href="TenantManager.html#createTenant">createTenant</a></li><li data-type='method'><a href="TenantManager.html#deleteTenant">deleteTenant</a></li><li data-type='method'><a href="TenantManager.html#getTenant">getTenant</a></li><li data-type='method'><a href="TenantManager.html#getTenantByDomain">getTenantByDomain</a></li><li data-type='method'><a href="TenantManager.html#getTenantDatabaseName">getTenantDatabaseName</a></li><li data-type='method'><a href="TenantManager.html#getTenantSchemaName">getTenantSchemaName</a></li><li data-type='method'><a href="TenantManager.html#initialize">initialize</a></li><li data-type='method'><a href="TenantManager.html#loadTenants">loadTenants</a></li><li data-type='method'><a href="TenantManager.html#tenantMiddleware">tenantMiddleware</a></li><li data-type='method'><a href="TenantManager.html#updateTenant">updateTenant</a></li></ul></li><li><a href="ValidationManager.html">ValidationManager</a><ul class='methods'><li data-type='method'><a href="ValidationManager.html#addSchema">addSchema</a></li><li data-type='method'><a href="ValidationManager.html#createValidationMiddleware">createValidationMiddleware</a></li><li data-type='method'><a href="ValidationManager.html#getSchema">getSchema</a></li><li data-type='method'><a href="ValidationManager.html#getSchemaNames">getSchemaNames</a></li><li data-type='method'><a href="ValidationManager.html#validate">validate</a></li></ul></li><li><a href="WorkflowEngine.html">WorkflowEngine</a><ul class='methods'><li data-type='method'><a href="WorkflowEngine.html#cancelWorkflow">cancelWorkflow</a></li><li data-type='method'><a href="WorkflowEngine.html#completeWorkflow">completeWorkflow</a></li><li data-type='method'><a href="WorkflowEngine.html#evaluateCondition">evaluateCondition</a></li><li data-type='method'><a href="WorkflowEngine.html#executeActions">executeActions</a></li><li data-type='method'><a href="WorkflowEngine.html#executeStateActions">executeStateActions</a></li><li data-type='method'><a href="WorkflowEngine.html#executeTransition">executeTransition</a></li><li data-type='method'><a href="WorkflowEngine.html#getWorkflowInstance">getWorkflowInstance</a></li><li data-type='method'><a href="WorkflowEngine.html#getWorkflowInstancesForEntity">getWorkflowInstancesForEntity</a></li><li data-type='method'><a href="WorkflowEngine.html#handleWorkflowCancel">handleWorkflowCancel</a></li><li data-type='method'><a href="WorkflowEngine.html#handleWorkflowComplete">handleWorkflowComplete</a></li><li data-type='method'><a href="WorkflowEngine.html#handleWorkflowStart">handleWorkflowStart</a></li><li data-type='method'><a href="WorkflowEngine.html#handleWorkflowTransition">handleWorkflowTransition</a></li><li data-type='method'><a href="WorkflowEngine.html#initialize">initialize</a></li><li data-type='method'><a href="WorkflowEngine.html#loadWorkflows">loadWorkflows</a></li><li data-type='method'><a href="WorkflowEngine.html#mapDatabaseInstanceToObject">mapDatabaseInstanceToObject</a></li><li data-type='method'><a href="WorkflowEngine.html#saveWorkflowInstance">saveWorkflowInstance</a></li><li data-type='method'><a href="WorkflowEngine.html#setupEventListeners">setupEventListeners</a></li><li data-type='method'><a href="WorkflowEngine.html#startWorkflow">startWorkflow</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#$randomEmail">$randomEmail</a></li><li><a href="global.html#applyMiddleware">applyMiddleware</a></li><li><a href="global.html#calculatePercentile">calculatePercentile</a></li><li><a href="global.html#closeConnections">closeConnections</a></li><li><a href="global.html#closeDatabaseConnections">closeDatabaseConnections</a></li><li><a href="global.html#connectDatabases">connectDatabases</a></li><li><a href="global.html#connectMockDatabase">connectMockDatabase</a></li><li><a href="global.html#connectMongoDB">connectMongoDB</a></li><li><a href="global.html#connectPostgres">connectPostgres</a></li><li><a href="global.html#connectRedis">connectRedis</a></li><li><a href="global.html#createMigration">createMigration</a></li><li><a href="global.html#createMigrationsTable">createMigrationsTable</a></li><li><a href="global.html#deepMerge">deepMerge</a></li><li><a href="global.html#generateApiClient">generateApiClient</a></li><li><a href="global.html#generateGraphQLComposables">generateGraphQLComposables</a></li><li><a href="global.html#generateGraphQLHooks">generateGraphQLHooks</a></li><li><a href="global.html#generateIndexFile">generateIndexFile</a></li><li><a href="global.html#generateReactSDK">generateReactSDK</a></li><li><a href="global.html#generateRestComposables">generateRestComposables</a></li><li><a href="global.html#generateRestHooks">generateRestHooks</a></li><li><a href="global.html#generateVueSDK">generateVueSDK</a></li><li><a href="global.html#generateWebSocketComposables">generateWebSocketComposables</a></li><li><a href="global.html#generateWebSocketHooks">generateWebSocketHooks</a></li><li><a href="global.html#getAppliedMigrations">getAppliedMigrations</a></li><li><a href="global.html#getDatabaseClient">getDatabaseClient</a></li><li><a href="global.html#hasRoles">hasRoles</a></li><li><a href="global.html#isAuthenticated">isAuthenticated</a></li><li><a href="global.html#isObject">isObject</a></li><li><a href="global.html#loadConfig">loadConfig</a></li><li><a href="global.html#logger">logger</a></li><li><a href="global.html#mergeResolvers">mergeResolvers</a></li><li><a href="global.html#parseConfigValue">parseConfigValue</a></li><li><a href="global.html#recordMigration">recordMigration</a></li><li><a href="global.html#registerGRPCService">registerGRPCService</a></li><li><a href="global.html#registerModelEventHandlers">registerModelEventHandlers</a></li><li><a href="global.html#registerModelRoutes">registerModelRoutes</a></li><li><a href="global.html#runConcurrentTests">runConcurrentTests</a></li><li><a href="global.html#runMigrations">runMigrations</a></li><li><a href="global.html#runPerformanceTests">runPerformanceTests</a></li><li><a href="global.html#runTests">runTests</a></li><li><a href="global.html#selectRandomProduct">selectRandomProduct</a></li><li><a href="global.html#setNestedValue">setNestedValue</a></li><li><a href="global.html#setupApiKeyStrategy">setupApiKeyStrategy</a></li><li><a href="global.html#setupAuthRoutes">setupAuthRoutes</a></li><li><a href="global.html#setupAuthentication">setupAuthentication</a></li><li><a href="global.html#setupGRPC">setupGRPC</a></li><li><a href="global.html#setupGraphQLSchema">setupGraphQLSchema</a></li><li><a href="global.html#setupHealthChecks">setupHealthChecks</a></li><li><a href="global.html#setupJwtStrategy">setupJwtStrategy</a></li><li><a href="global.html#setupMonitoring">setupMonitoring</a></li><li><a href="global.html#setupMySQL">setupMySQL</a></li><li><a href="global.html#setupOAuth2Strategies">setupOAuth2Strategies</a></li><li><a href="global.html#setupRESTApi">setupRESTApi</a></li><li><a href="global.html#setupRateLimiting">setupRateLimiting</a></li><li><a href="global.html#setupWebSockets">setupWebSockets</a></li><li><a href="global.html#simpleTest">simpleTest</a></li><li><a href="global.html#tenantContextMiddleware">tenantContextMiddleware</a></li><li><a href="global.html#testAI">testAI</a></li><li><a href="global.html#testAIServices">testAIServices</a></li><li><a href="global.html#testAsyncFunction">testAsyncFunction</a></li><li><a href="global.html#testAudit">testAudit</a></li><li><a href="global.html#testCache">testCache</a></li><li><a href="global.html#testEdgeComputing">testEdgeComputing</a></li><li><a href="global.html#testEndpoint">testEndpoint</a></li><li><a href="global.html#testEventSystem">testEventSystem</a></li><li><a href="global.html#testEvents">testEvents</a></li><li><a href="global.html#testFeatures">testFeatures</a></li><li><a href="global.html#testI18n">testI18n</a></li><li><a href="global.html#testMultiTenant">testMultiTenant</a></li><li><a href="global.html#testSecurity">testSecurity</a></li><li><a href="global.html#testValidation">testValidation</a></li><li><a href="global.html#testWorkflow">testWorkflow</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">core/audit/index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const { v4: uuidv4 } = require('uuid');
const logger = require('../utils/logger');

/**
 * Audit Manager
 */
class AuditManager {
  constructor(config = {}, dbConnections = {}) {
    this.config = config;
    this.dbConnections = dbConnections;
    this.middleware = this.createAuditMiddleware.bind(this);
  }
  
  /**
   * Initialize audit manager
   */
  async initialize() {
    try {
      // Create audit tables if they don't exist
      await this.createAuditTables();
      
      logger.info('Audit manager initialized');
      return true;
    } catch (error) {
      logger.error('Failed to initialize audit manager:', error);
      throw error;
    }
  }
  
  /**
   * Create audit tables
   */
  async createAuditTables() {
    try {
      // Choose the appropriate database client based on configuration
      const dbClient = this.dbConnections[this.config.database || 'postgres'];
      
      if (!dbClient) {
        throw new Error(`Database client not found for audit storage: ${this.config.database}`);
      }
      
      if (this.config.database === 'postgres' || this.config.database === 'mysql') {
        // Create audit_logs table
        await dbClient.query(`
          CREATE TABLE IF NOT EXISTS audit_logs (
            id VARCHAR(36) PRIMARY KEY,
            user_id VARCHAR(255),
            action VARCHAR(255) NOT NULL,
            entity_type VARCHAR(255) NOT NULL,
            entity_id VARCHAR(255),
            changes JSONB,
            metadata JSONB,
            ip_address VARCHAR(45),
            user_agent TEXT,
            created_at TIMESTAMP NOT NULL DEFAULT NOW()
          );
          
          CREATE INDEX IF NOT EXISTS idx_audit_logs_user_id ON audit_logs (user_id);
          CREATE INDEX IF NOT EXISTS idx_audit_logs_action ON audit_logs (action);
          CREATE INDEX IF NOT EXISTS idx_audit_logs_entity_type ON audit_logs (entity_type);
          CREATE INDEX IF NOT EXISTS idx_audit_logs_entity_id ON audit_logs (entity_id);
          CREATE INDEX IF NOT EXISTS idx_audit_logs_created_at ON audit_logs (created_at);
        `);
        
        // Create data_access_logs table
        await dbClient.query(`
          CREATE TABLE IF NOT EXISTS data_access_logs (
            id VARCHAR(36) PRIMARY KEY,
            user_id VARCHAR(255),
            action VARCHAR(255) NOT NULL,
            entity_type VARCHAR(255) NOT NULL,
            entity_id VARCHAR(255),
            fields TEXT[],
            query JSONB,
            ip_address VARCHAR(45),
            user_agent TEXT,
            created_at TIMESTAMP NOT NULL DEFAULT NOW()
          );
          
          CREATE INDEX IF NOT EXISTS idx_data_access_logs_user_id ON data_access_logs (user_id);
          CREATE INDEX IF NOT EXISTS idx_data_access_logs_action ON data_access_logs (action);
          CREATE INDEX IF NOT EXISTS idx_data_access_logs_entity_type ON data_access_logs (entity_type);
          CREATE INDEX IF NOT EXISTS idx_data_access_logs_entity_id ON data_access_logs (entity_id);
          CREATE INDEX IF NOT EXISTS idx_data_access_logs_created_at ON data_access_logs (created_at);
        `);
      } else if (this.config.database === 'mongodb') {
        // Create indexes for MongoDB collections
        await dbClient.collection('audit_logs').createIndexes([
          { key: { user_id: 1 } },
          { key: { action: 1 } },
          { key: { entity_type: 1 } },
          { key: { entity_id: 1 } },
          { key: { created_at: 1 } }
        ]);
        
        await dbClient.collection('data_access_logs').createIndexes([
          { key: { user_id: 1 } },
          { key: { action: 1 } },
          { key: { entity_type: 1 } },
          { key: { entity_id: 1 } },
          { key: { created_at: 1 } }
        ]);
      }
      
      return true;
    } catch (error) {
      logger.error('Failed to create audit tables:', error);
      throw error;
    }
  }
  
  /**
   * Create audit middleware
   */
  createAuditMiddleware() {
    return (req, res, next) => {
      // Initialize audit context
      req.auditContext = {
        startTime: Date.now()
      };
      
      // Capture original response methods
      const originalSend = res.send;
      const originalJson = res.json;
      const originalEnd = res.end;
      
      // Override response methods to capture data
      res.send = function(body) {
        this.auditBody = body;
        return originalSend.apply(this, arguments);
      };
      
      res.json = function(body) {
        this.auditBody = body;
        return originalJson.apply(this, arguments);
      };
      
      res.end = function(chunk, encoding) {
        // Restore original methods
        res.send = originalSend;
        res.json = originalJson;
        res.end = originalEnd;
        
        // Log the request/response
        const auditContext = req.auditContext || {};
        
        // Only log if the request matches the configured paths
        if (this.shouldAuditRequest(req, auditContext)) {
          this.logAccess({
            userId: req.user?.id,
            action: auditContext.action || req.method,
            entityType: auditContext.entityType,
            entityId: auditContext.entityId,
            fields: auditContext.fields,
            query: {
              params: req.params,
              query: req.query,
              body: this.sanitizeRequestBody(req.body)
            },
            ipAddress: req.ip,
            userAgent: req.get('user-agent'),
            responseStatus: res.statusCode,
            responseTime: Date.now() - auditContext.startTime
          });
        }
        
        return originalEnd.apply(this, arguments);
      }.bind(this);
      
      next();
    };
  }
  
  /**
   * Check if request should be audited
   */
  shouldAuditRequest(req, auditContext) {
    // Skip if auditing is disabled
    if (!this.config.enabled) {
      return false;
    }
    
    // Skip if path is excluded
    if (this.config.excludePaths) {
      for (const pattern of this.config.excludePaths) {
        if (typeof pattern === 'string' &amp;&amp; req.path.startsWith(pattern)) {
          return false;
        } else if (pattern instanceof RegExp &amp;&amp; pattern.test(req.path)) {
          return false;
        }
      }
    }
    
    // Skip if method is excluded
    if (this.config.excludeMethods &amp;&amp; this.config.excludeMethods.includes(req.method)) {
      return false;
    }
    
    // Include if path is explicitly included
    if (this.config.includePaths) {
      for (const pattern of this.config.includePaths) {
        if (typeof pattern === 'string' &amp;&amp; req.path.startsWith(pattern)) {
          return true;
        } else if (pattern instanceof RegExp &amp;&amp; pattern.test(req.path)) {
          return true;
        }
      }
      
      // If includePaths is specified but none match, skip
      return false;
    }
    
    // Include if audit context has entity type
    if (auditContext.entityType) {
      return true;
    }
    
    // Default to config setting
    return this.config.auditAllRequests || false;
  }
  
  /**
   * Sanitize request body for logging
   */
  sanitizeRequestBody(body) {
    if (!body) return null;
    
    const sanitized = { ...body };
    
    // Remove sensitive fields
    const sensitiveFields = this.config.sensitiveFields || [
      'password', 'token', 'secret', 'apiKey', 'api_key', 'credit_card',
      'creditCard', 'ssn', 'social_security', 'socialSecurity'
    ];
    
    for (const field of sensitiveFields) {
      if (sanitized[field]) {
        sanitized[field] = '[REDACTED]';
      }
    }
    
    return sanitized;
  }
  
  /**
   * Log data access
   */
  async logAccess(data) {
    try {
      const dbClient = this.dbConnections[this.config.database || 'postgres'];
      
      if (!dbClient) {
        logger.warn('Database client not found for audit logging');
        return;
      }
      
      const accessLog = {
        id: uuidv4(),
        user_id: data.userId,
        action: data.action,
        entity_type: data.entityType,
        entity_id: data.entityId,
        fields: data.fields,
        query: data.query,
        ip_address: data.ipAddress,
        user_agent: data.userAgent,
        created_at: new Date()
      };
      
      if (this.config.database === 'postgres' || this.config.database === 'mysql') {
        await dbClient.query(
          `INSERT INTO data_access_logs (
            id, user_id, action, entity_type, entity_id, fields, query, 
            ip_address, user_agent, created_at
          ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)`,
          [
            accessLog.id,
            accessLog.user_id,
            accessLog.action,
            accessLog.entity_type,
            accessLog.entity_id,
            accessLog.fields,
            JSON.stringify(accessLog.query),
            accessLog.ip_address,
            accessLog.user_agent,
            accessLog.created_at
          ]
        );
      } else if (this.config.database === 'mongodb') {
        await dbClient.collection('data_access_logs').insertOne(accessLog);
      }
      
      if (this.config.logToConsole) {
        logger.debug('Data access logged:', {
          userId: data.userId,
          action: data.action,
          entityType: data.entityType,
          entityId: data.entityId,
          responseStatus: data.responseStatus,
          responseTime: data.responseTime
        });
      }
      
      return accessLog.id;
    } catch (error) {
      logger.error('Failed to log data access:', error);
      // Don't throw error to avoid disrupting the application flow
      return null;
    }
  }
  
  /**
   * Log entity changes
   */
  async logChanges(data) {
    try {
      const dbClient = this.dbConnections[this.config.database || 'postgres'];
      
      if (!dbClient) {
        logger.warn('Database client not found for audit logging');
        return;
      }
      
      const auditLog = {
        id: uuidv4(),
        user_id: data.userId,
        action: data.action,
        entity_type: data.entityType,
        entity_id: data.entityId,
        changes: data.changes,
        metadata: data.metadata,
        ip_address: data.ipAddress,
        user_agent: data.userAgent,
        created_at: new Date()
      };
      
      if (this.config.database === 'postgres' || this.config.database === 'mysql') {
        await dbClient.query(
          `INSERT INTO audit_logs (
            id, user_id, action, entity_type, entity_id, changes, metadata, 
            ip_address, user_agent, created_at
          ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)`,
          [
            auditLog.id,
            auditLog.user_id,
            auditLog.action,
            auditLog.entity_type,
            auditLog.entity_id,
            JSON.stringify(auditLog.changes),
            JSON.stringify(auditLog.metadata),
            auditLog.ip_address,
            auditLog.user_agent,
            auditLog.created_at
          ]
        );
      } else if (this.config.database === 'mongodb') {
        await dbClient.collection('audit_logs').insertOne(auditLog);
      }
      
      if (this.config.logToConsole) {
        logger.debug('Entity changes logged:', {
          userId: data.userId,
          action: data.action,
          entityType: data.entityType,
          entityId: data.entityId
        });
      }
      
      return auditLog.id;
    } catch (error) {
      logger.error('Failed to log entity changes:', error);
      // Don't throw error to avoid disrupting the application flow
      return null;
    }
  }
  
  /**
   * Get audit logs for entity
   */
  async getAuditLogsForEntity(entityType, entityId, options = {}) {
    try {
      const dbClient = this.dbConnections[this.config.database || 'postgres'];
      
      if (!dbClient) {
        throw new Error('Database client not found for audit retrieval');
      }
      
      let logs = [];
      
      if (this.config.database === 'postgres' || this.config.database === 'mysql') {
        let query = 'SELECT * FROM audit_logs WHERE entity_type = $1 AND entity_id = $2';
        const params = [entityType, entityId];
        
        if (options.action) {
          query += ' AND action = $3';
          params.push(options.action);
        }
        
        if (options.userId) {
          query += ` AND user_id = $${params.length + 1}`;
          params.push(options.userId);
        }
        
        if (options.startDate) {
          query += ` AND created_at >= $${params.length + 1}`;
          params.push(options.startDate);
        }
        
        if (options.endDate) {
          query += ` AND created_at &lt;= $${params.length + 1}`;
          params.push(options.endDate);
        }
        
        query += ' ORDER BY created_at DESC';
        
        if (options.limit) {
          query += ` LIMIT $${params.length + 1}`;
          params.push(options.limit);
        }
        
        if (options.offset) {
          query += ` OFFSET $${params.length + 1}`;
          params.push(options.offset);
        }
        
        const result = await dbClient.query(query, params);
        logs = result.rows || result;
      } else if (this.config.database === 'mongodb') {
        const query = { entity_type: entityType, entity_id: entityId };
        
        if (options.action) {
          query.action = options.action;
        }
        
        if (options.userId) {
          query.user_id = options.userId;
        }
        
        if (options.startDate || options.endDate) {
          query.created_at = {};
          
          if (options.startDate) {
            query.created_at.$gte = options.startDate;
          }
          
          if (options.endDate) {
            query.created_at.$lte = options.endDate;
          }
        }
        
        let cursor = dbClient.collection('audit_logs')
          .find(query)
          .sort({ created_at: -1 });
        
        if (options.limit) {
          cursor = cursor.limit(options.limit);
        }
        
        if (options.offset) {
          cursor = cursor.skip(options.offset);
        }
        
        logs = await cursor.toArray();
      }
      
      return logs;
    } catch (error) {
      logger.error('Failed to get audit logs for entity:', error);
      throw error;
    }
  }
  
  /**
   * Get data access logs for entity
   */
  async getAccessLogsForEntity(entityType, entityId, options = {}) {
    try {
      const dbClient = this.dbConnections[this.config.database || 'postgres'];
      
      if (!dbClient) {
        throw new Error('Database client not found for audit retrieval');
      }
      
      let logs = [];
      
      if (this.config.database === 'postgres' || this.config.database === 'mysql') {
        let query = 'SELECT * FROM data_access_logs WHERE entity_type = $1 AND entity_id = $2';
        const params = [entityType, entityId];
        
        if (options.action) {
          query += ' AND action = $3';
          params.push(options.action);
        }
        
        if (options.userId) {
          query += ` AND user_id = $${params.length + 1}`;
          params.push(options.userId);
        }
        
        if (options.startDate) {
          query += ` AND created_at >= $${params.length + 1}`;
          params.push(options.startDate);
        }
        
        if (options.endDate) {
          query += ` AND created_at &lt;= $${params.length + 1}`;
          params.push(options.endDate);
        }
        
        query += ' ORDER BY created_at DESC';
        
        if (options.limit) {
          query += ` LIMIT $${params.length + 1}`;
          params.push(options.limit);
        }
        
        if (options.offset) {
          query += ` OFFSET $${params.length + 1}`;
          params.push(options.offset);
        }
        
        const result = await dbClient.query(query, params);
        logs = result.rows || result;
      } else if (this.config.database === 'mongodb') {
        const query = { entity_type: entityType, entity_id: entityId };
        
        if (options.action) {
          query.action = options.action;
        }
        
        if (options.userId) {
          query.user_id = options.userId;
        }
        
        if (options.startDate || options.endDate) {
          query.created_at = {};
          
          if (options.startDate) {
            query.created_at.$gte = options.startDate;
          }
          
          if (options.endDate) {
            query.created_at.$lte = options.endDate;
          }
        }
        
        let cursor = dbClient.collection('data_access_logs')
          .find(query)
          .sort({ created_at: -1 });
        
        if (options.limit) {
          cursor = cursor.limit(options.limit);
        }
        
        if (options.offset) {
          cursor = cursor.skip(options.offset);
        }
        
        logs = await cursor.toArray();
      }
      
      return logs;
    } catch (error) {
      logger.error('Failed to get data access logs for entity:', error);
      throw error;
    }
  }
  
  /**
   * Create audit context for a request
   */
  createAuditContext(req, entityType, entityId, action, fields = null) {
    req.auditContext = {
      ...req.auditContext,
      entityType,
      entityId,
      action,
      fields,
      startTime: req.auditContext?.startTime || Date.now()
    };
    
    return req.auditContext;
  }
  
  /**
   * Generate GDPR data export for user
   */
  async generateGDPRExport(userId) {
    try {
      const dbClient = this.dbConnections[this.config.database || 'postgres'];
      
      if (!dbClient) {
        throw new Error('Database client not found for GDPR export');
      }
      
      // Get all audit logs for user
      let auditLogs = [];
      let accessLogs = [];
      
      if (this.config.database === 'postgres' || this.config.database === 'mysql') {
        const auditResult = await dbClient.query(
          'SELECT * FROM audit_logs WHERE user_id = $1 ORDER BY created_at DESC',
          [userId]
        );
        
        auditLogs = auditResult.rows || auditResult;
        
        const accessResult = await dbClient.query(
          'SELECT * FROM data_access_logs WHERE user_id = $1 ORDER BY created_at DESC',
          [userId]
        );
        
        accessLogs = accessResult.rows || accessResult;
      } else if (this.config.database === 'mongodb') {
        auditLogs = await dbClient.collection('audit_logs')
          .find({ user_id: userId })
          .sort({ created_at: -1 })
          .toArray();
        
        accessLogs = await dbClient.collection('data_access_logs')
          .find({ user_id: userId })
          .sort({ created_at: -1 })
          .toArray();
      }
      
      // Format data for export
      const exportData = {
        userId,
        exportDate: new Date(),
        auditLogs: auditLogs.map(log => ({
          action: log.action,
          entityType: log.entity_type,
          entityId: log.entity_id,
          changes: log.changes,
          timestamp: log.created_at,
          ipAddress: log.ip_address
        })),
        accessLogs: accessLogs.map(log => ({
          action: log.action,
          entityType: log.entity_type,
          entityId: log.entity_id,
          timestamp: log.created_at,
          ipAddress: log.ip_address
        }))
      };
      
      return exportData;
    } catch (error) {
      logger.error('Failed to generate GDPR export:', error);
      throw error;
    }
  }
  
  /**
   * Execute right to be forgotten for user
   */
  async executeRightToBeForgotten(userId) {
    try {
      const dbClient = this.dbConnections[this.config.database || 'postgres'];
      
      if (!dbClient) {
        throw new Error('Database client not found for right to be forgotten');
      }
      
      // Log the request
      await this.logChanges({
        userId: 'system',
        action: 'RIGHT_TO_BE_FORGOTTEN',
        entityType: 'user',
        entityId: userId,
        changes: { status: 'anonymized' },
        metadata: { reason: 'GDPR request' },
        ipAddress: '127.0.0.1',
        userAgent: 'System'
      });
      
      // Anonymize user data in audit logs
      if (this.config.database === 'postgres' || this.config.database === 'mysql') {
        await dbClient.query(
          'UPDATE audit_logs SET ip_address = NULL, user_agent = NULL WHERE user_id = $1',
          [userId]
        );
        
        await dbClient.query(
          'UPDATE data_access_logs SET ip_address = NULL, user_agent = NULL WHERE user_id = $1',
          [userId]
        );
      } else if (this.config.database === 'mongodb') {
        await dbClient.collection('audit_logs').updateMany(
          { user_id: userId },
          { $set: { ip_address: null, user_agent: null } }
        );
        
        await dbClient.collection('data_access_logs').updateMany(
          { user_id: userId },
          { $set: { ip_address: null, user_agent: null } }
        );
      }
      
      return true;
    } catch (error) {
      logger.error('Failed to execute right to be forgotten:', error);
      throw error;
    }
  }
}

module.exports = AuditManager; </code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
